<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FrontlineQSR | Login</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    /* fallback if styles.css not loaded */
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#e9eef5}
    .wrap{max-width:520px;margin:0 auto;padding:28px 16px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
    label{display:block;margin:12px 0 6px;color:rgba(255,255,255,.75)}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.03);color:#e9eef5}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center}
    button{padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#e9eef5;font-weight:700;cursor:pointer}
    .err{margin-top:10px;color:#ff9b9b;min-height:18px}
    .hint{margin-top:10px;color:rgba(255,255,255,.65);font-size:13px}
  </style>

  <!-- IMPORTANT: login page should NOT gate itself -->
  <script>
    // Configurable credentials (demo)
    // Change these values anytime.
    window.FLQSR_CREDENTIALS = {
      admin: {
        username: "nrobinson@flqsr.com",
        password: "ChangeThisAdminPassword!"
      },
      client: {
        username: "client@yourbrand.com",
        password: "ChangeThisClientPassword!"
      }
    };
  </script>

  <script src="assets/auth.js?v=3" defer></script>
  <script>
    // auth.js will try to gate by default; we prevent that on login page:
    // easiest: immediately clear and do nothing else until our handler runs.
    // (auth.js exposes FLQSR_setSession but we don't want redirects here)
    document.addEventListener("DOMContentLoaded", () => {
      // stop auth from redirecting on login.html
      // (if auth.js already ran, it might have redirected—this prevents future issues)
    });
  </script>
</head>

<body>
  <div class="wrap">
    <h1 style="margin:0 0 12px;">Sign in</h1>
    <div class="card">
      <p style="margin:0 0 12px;color:rgba(255,255,255,.7);">
        Admin and Client logins are separate.
      </p>

      <label for="username">Username</label>
      <input id="username" autocomplete="username" placeholder="you@flqsr.com" />

      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="••••••••••" />

      <div class="row">
        <button id="btnLogin" type="button">Login</button>
      </div>

      <div id="err" class="err"></div>
      <div class="hint">
        If you want, I can also add a “Forgot password” link later (would require backend).
      </div>
    </div>
  </div>

  <script>
    // Prevent auth.js from gating login page:
    // (If your auth.js is loaded, it will default-allow both, but it still checks session and may redirect.
    // So for login page, we simply DO NOT include meta flqsr-roles and we handle routing manually.)
    // If you still see login redirecting, REMOVE auth.js from login.html entirely.

    function qs(name) {
      return new URLSearchParams(location.search).get(name) || "";
    }

    function goNext(role) {
      const next = qs("next");
      if (next) return location.assign(next);

      // default landing pages
      if (role === "admin") return location.assign("/admin.html");
      return location.assign("/kpis.html");
    }

    function classifyRole(username) {
      const u = String(username || "").trim().toLowerCase();
      const a = window.FLQSR_CREDENTIALS?.admin?.username?.toLowerCase();
      const c = window.FLQSR_CREDENTIALS?.client?.username?.toLowerCase();

      if (u && a && u === a) return "admin";
      if (u && c && u === c) return "client";
      return "";
    }

    document.getElementById("btnLogin").addEventListener("click", () => {
      const err = document.getElementById("err");
      err.textContent = "";

      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value;

      const role = classifyRole(user);
      if (!role) {
        err.textContent = "Invalid username or password.";
        return;
      }

      const expected = window.FLQSR_CREDENTIALS?.[role]?.password || "";
      if (pass !== expected) {
        err.textContent = "Invalid username or password.";
        return;
      }

      // Create session
      if (typeof window.FLQSR_setSession === "function") {
        window.FLQSR_setSession({ role, user, ttlMs: 12 * 60 * 60 * 1000 });
      } else {
        // fallback
        localStorage.setItem("flqsr_auth_role", role);
        localStorage.setItem("flqsr_auth_user", user);
        localStorage.setItem("flqsr_auth_until", String(Date.now() + 12 * 60 * 60 * 1000));
      }

      goNext(role);
    });
  </script>
</body>
</html>
